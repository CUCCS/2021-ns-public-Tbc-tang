# 实验十一 常见蜜罐体验和探索

## 实验目的

- 了解蜜罐的分类和基本原理
- 了解不同类型蜜罐的适用场合
- 掌握常见蜜罐的搭建和使用
- 从 [paralax/awesome-honeypots](https://github.com/paralax/awesome-honeypots) 中选择 1 种低交互蜜罐和 1 种中等交互蜜罐进行搭建实验

## 实验要求

- [x] 记录蜜罐的详细搭建过程；
- [x] 使用`nmap`扫描搭建好的蜜罐并分析扫描结果，同时分析「 nmap 扫描期间」蜜罐上记录得到的信息；
- [x] 如何辨别当前目标是一个「蜜罐」？以自己搭建的蜜罐为例进行说明；
- [x] （可选）总结常见的蜜罐识别和检测方法；
- [ ] （可选）基于 canarytokens 搭建蜜信实验环境进行自由探索型实验

## 网络拓扑

![topology](/img/0x0b_topology.png)

## 实验环境

- kali 2021.2
- [twisted-honeypots(此条作废)](https://github.com/lanjelot/twisted-honeypots)
- [sshesame](https://github.com/jaksi/sshesame)
- [cowrie](https://github.com/cowrie/cowrie)

## 实验步骤

### 低交互蜜罐 ~~Twisted Honeypots~~ Sshesame

- ~~选择Twisted Honeypots的原因~~

  ~~首先是因为它界面非常友好，也已经给了我相关安装说明；其次，虽然它的点赞数和fork数不高，而且最近一次更新是19年10月，不过我在仓库贡献者里瞥了眼，看到了一位师姐，这坚定了我选它的决心[doge]~~

![](/img/0x0b_reasons-1.png)

悲剧的地方来了：构建这个是没问题的，但是当前我的python版本（准确的说是python 3.9）已经不支持这个项目中部分脚本的命令了，具体来说是其中的`twistd`命令，需要换一种方式执行才可以

> 但我懒得搞就换新的方案了……

- 为什么选择sshesame？

	如下图，大量的点赞，最近（本文写于2021.11.29）经过更新，最重要的是有asciinema作为演示视频，可以说是非常友好了

![](/img/0x0b_reasons-2.png)

- 安装&运行sshesame

```bash
$ sudo docker run -it --rm\
    -p 127.0.0.1:2022:2022\
    -v sshesame-data:/data ghcr.io/jaksi/sshesame
```

安装完成后，用tmux分屏，输入`ssh -p 2022 127.0.0.1`链接上蜜罐

![](/img/0x0b_sshesame-1.png)

可以看出来这个蜜罐主要是演示性质的(毕竟都一开始就告诉你这是蜜罐了…)，不过我们还是实验一些常见的命令吧

> ps: 作者的项目介绍：An easy to set up and use SSH honeypot, a fake SSH server that lets anyone in and logs their activity

![0x0b_sshesame-2](/img/0x0b_sshesame-2.png)

![0x0b_sshesame-3](/img/0x0b_sshesame-3.png)

如图，所有的命令都没有用，文件也找不到，但是蜜罐里会有相应的监视输入反馈，在蜜罐中的所有操作都被清晰的记录了

---

### 中等交互蜜罐 Cowrie SSH Honeypot

- 为什么选择cowrie？

  如下图，最近一次更新在3天前，大量的点赞和fork，非常多的提交，而且如果你细心一些，查看提交之间的比对的话，你会发现作者通过的都是有意义的提交，质量很高，说明这是一个有人精心维护、有良好社区的开源项目，你的实验多半不会进行到一半就因为不兼容或命令过期之类的问题而做不下去了
  
  ![](/img/0x0b_reasons-3.png)

```bash
# 安装镜像
git clone https://github.com/cowrie/docker-cowrie.git
cd docker-cowrie/   
docker pull cowrie/cowrie
# 启动
docker run -p 2222:2222 cowrie/cowrie
```

![](/img/0x0b_cowrie-1.png)

![](/img/0x0b_cowrie-2.png)

如图，我们已经成功构建了蜜罐，接下来做测试就好了

#### 测试

- 在攻击者主机上用nmap扫描以发现端口

![](/img/0x0b_cowrie-test-1.png)

- 使用ssh登录，多试几次就能发现，使用root+任意密码都可以登录，而非root用户无法登陆，使用 `ssh -c` 不影响结果

- 登录之后开始常规的尝试操作，测测它有没有露马脚

![0x0b_cowrie-test-2](/img/0x0b_cowrie-test-2.png)

![0x0b_cowrie-test-3](/img/0x0b_cowrie-test-3.png)

![0x0b_cowrie-test-4](/img/0x0b_cowrie-test-4.png)

![0x0b_cowrie-test-5](/img/0x0b_cowrie-test-5.png)

在靶机这边，可以看到有相关的日志信息在不断产生，之前的图做的操作都有说明，所以这里偷个懒就不用jq再看一遍日志了

![0x0b_cowrie-test-6](/img/0x0b_cowrie-test-6.png)

- 让人怀疑是蜜罐的地方

1. curl没有反应

   ![](/img/0x0b_cowrie-doubt-1.png)

2. `echo $PATH`明显有问题

   ![](/img/0x0b_cowrie-doubt-2.png)

3. `apt-get update`有问题&虽然可以正常下载安装包(比如我用docker举例)，但是当你打算运行的时候就会露马脚

   ![](/img/0x0b_cowrie-doubt-3.png)

4. 连接会自动退出，大约在3min左右

   ![](/img/0x0b_cowrie-doubt-4.png)

5. `lsb_release -a`找不到命令

   ![](/img/0x0b_cowrie-doubt-5.png)

---

### 常见的蜜罐识别和检测方法

> 此处的参考链接有：
>
> - [如何判断是不是进入了蜜罐？](https://www.zhihu.com/question/31213254)
>- [浅谈网络蜜罐技术](https://zhuanlan.zhihu.com/p/144058033)
> - [对蜜罐系统理解的总结](https://blog.csdn.net/a821478424/article/details/50393429)
> - [[Is it possible to detect a honeypot?](https://security.stackexchange.com/questions/90642/is-it-possible-to-detect-a-honeypot)

1. 常规命令的检测。如本实验所用的 `echo $PATH` 等各种命令，可以上手来一套。这里不展开说明。
2. 部分低交互蜜罐使用nmap请求哪个端口就会开放哪个端口，所以可以多尝试几次。
3. 蜜罐攻陷的成本是非常低的，如果你非常轻易的就骇入了漏洞过于明显的系统，就值得怀疑。
4. 你可以给web服务器发送大量http请求，导致web服务器抢占大量计算机资源用来处理请求。这样就会让蜜罐的反应慢下来，算是一种反制手段。
5. 检测UML(User Mode Linux)。[论文的III-A](https://www.ei.ruhr-uni-bochum.de/media/emma/veroeffentlichungen/2012/08/07/Honeypots-IEEE05.pdf)阐述了具体操作。
6. 数据包时间戳分析、分析低交互蜜罐产生的网络响应来寻找差异、环境不真实导致穿帮。
7. 最后，还有一点玄学（指所谓“资深网络安全工程师的经验”），反正我没有[😓]

---

### 参考链接

[sshesame](https://github.com/jaksi/sshesame)

[cowrie](https://github.com/cowrie/cowrie)

[师姐的作业](https://github.com/CUCCS/2020-ns-public-LyuLumos/tree/ch0x0B/ch0x0B)

[课本](https://c4pr1c3.gitee.io/cuc-ns/chap0x11/main.html)