# 第三章实验 HTTP正向代理实验

## 实验要求

​	在Kali Linux中安装tinyproxy，然后用主机设置浏览器代理指向tinyproxy建立的HTTP正向代理，在Kali中用wireshark抓包，分析抓包过程，理解HTTP正向代理HTTPS流量的特点。

## 实验准备

* 虚拟机应该配置为NAT与host-only网卡

* 在kali虚拟机中下载tinyproxy

  ```bash
  sudo apt install tinyproxy
  ```

* 取消注释allow 10.0.0.0/8

  ```bash
  sudo vim /etc/tinyproxy/tinyproxy.conf
  ```

![](/img/0x03_2.png)

---

## 实验步骤

### 课内实验

1. 用vim创建proxy.php文件

```
<?php
var_dump($_SERVER);
```

2. 打开PHP 测试用服务器

```
# 开启 PHP 测试用服务器
php -S 0.0.0.0:8080 proxy.php
```

3. 测试

```
# 开启新终端，使用 curl 模拟使用代理服务器的客户端
curl -H "X-Forwarded-For: 8.8.8.8" http://127.0.0.1:8080/proxy.php
# 8.8.8.8可以随意更改，只要符合ipv4规定即可
# 样例输出（节选）
# array(18) {
#   ["REMOTE_ADDR"]=>
#   string(9) "127.0.0.1"
#   ["HTTP_X_FORWARDED_FOR"]=>
#   string(7) "8.8.8.8"
# }
```

也可以直接在浏览器打开，记得加上端口号

![](/img/0x03_3.png)

4. 开启tinyproxy

```
# 启动 tinyproxy
systemctl start tinyproxy
```

5. 访问前述 proxy.php

```
curl -x http://127.0.0.1:8888 http://127.0.0.1:8080/proxy.php
# array(19) {
#   ["REMOTE_ADDR"]=>
#   string(9) "127.0.0.1"
#   ["HTTP_HOST"]=>
#   string(14) "127.0.0.1:8080"
#   ["HTTP_VIA"]=>
#   string(32) "1.1 tinyproxy (tinyproxy/1.10.0)" # 代理服务器的自我标识
# }
```

![](/img/0x03_4.png)

6. 修改配置，在客户端请求头中加入客户端真实 IP，并重启 tinyproxy 服务，在新窗口中开启tinyproxy日志监控小程序

```
# 改配置
sudo sed -i.bak "s/#XTinyproxy Yes/XTinyproxy Yes/" /etc/tinyproxy/tinyproxy.conf
# 重启服务
systemctl restart tinyproxy
# 在独立 shell 窗口开启 tinyproxy 日志监控小程序
tail -F /var/log/tinyproxy/tinyproxy.log
```

7. 新开一个终端,访问 HTTPS 站点，查看相关信息比如支付宝首页，回到监控终端查看下信息

```
# 访问站点
curl -x http://127.0.0.1:8888 https://auth.alipay.com/login/index.htm
# 查看 HSTS 响应头
curl -I -x http://127.0.0.1:8888 https://auth.alipay.com/login/index.htm
# 嫌太长翻不了页可以用管道操作塞到less里，less是终端的一个文本查看工具，可以进行翻页操作，按q退出
curl -I -x http://127.0.0.1:8888 https://auth.alipay.com/login/index.htm | less
```

访问信息：

![](/img/0x03_5.png)

less中的响应头信息：

![](/img/0x03_6.png)

### 课后实验要求

* **HTTP代理服务器实验**

  **Q：**使用http代理服务器访问HTTPS站点时，通信传输内容是否会被代理服务器“看到”？

  **A：**结论是代理服务器不知道客户端和服务器的HTTPS通信内容，但代理服务器知道客户端访问了哪个HTTPS站点，这是由http代理的协议机制决定的：代理客户端会发送Connect请求到http代理服务器。

* **实验验证**

  在Kali Linux中安装tinyproxy，然后用主机设置浏览器代理指向tinyproxy建立的HTTP正向代理，在Kali中用wireshark抓包，分析抓包过程，理解HTTP正向代理HTTPS流量的特点。

### 网络拓扑

宿主机（win 10）：192.168.3.52

虚拟机（kali）：192.168.151.10

![](/img/0x03_7.png)

### 课后实验验证流程

1. 在Kali Linux中安装tinyproxy
2. 用主机设置浏览器代理指向tinyproxy建立的HTTP正向代理
3. 在Kali Linux中用wireshark抓包
4. 分析抓包过程，理解HTTP正向代理HTTPS流量的特点。

* 打开tinyproxy，并查看状态

![](/img/0x03_1.png)

* 修改配置，因为我们希望用host-only网卡与主机进行通信，所以要在tinyproxy中允许这192.168.151一网段内的设备接入

```bash
sudo vim /etc/tinyproxy/tinyproxy.conf
```

![](/img/0x03_8.png)

> 务必保证你的修改与主机配置的网卡的子网掩码一致，否则将会出现许多诡异的现象，比如说抓得到包却上不了网

* 在chrome浏览器中下载SwitchyOmega插件，将
* 用wireshark监控eth0、eth1两块网卡，此处eth0网卡是用来供代理服务器和目标网站服务器之间使用的，而eth1网卡是用来连接宿主机和代理服务器的

![](/img/0x03_9.png)

### 分析流量包

**一些参考：**wireshark分析HTTP代理流量技巧：

- http.request.method eq CONNECT 查看所有HTTPS代理请求

- http.request.method eq GET 查看所有HTTP GET代理请求

- [使用wireshark解密HTTPS流量的方法](http://support.citrix.com/article/CTX116557)

- 使用wireshark提取pcap包中的SSL证书

  - wireshark首选项中确认TCP协议的Allow subdissector to reassemble TCP streams选项处于启用状态

  ![](/img/0x03_10.png)

  - 通过显示筛选过滤规则（例如：tcp.port == 443），找到SSL会话
  - 通过packet list里的info列找到Certificate
    - 在packet details面板里依次展开Handshake Protocol: Certificate --> Certificates，如果有多个证书，会看到多个默认折叠起来的Certificate
    - 右键选中Certificate，在右键菜单里使用Export Selected Packet Bytes功能即可导出DER格式的SSL证书
  - 使用openssl命令行工具解析DER证书 openssl x509 -in xxx.der -inform der -text -noout

1. 对 `eth1` 抓取的流量使用 `http.request.method eq CONNECT 查看所有HTTPS代理请求`

![](/img/0x03_11.png)

选中后点击右键-追踪流-tcp流

![](/img/0x03_14.png)

可以看到，这是其中的内容是加密了的，代理服务器并不知道传输的具体内容是什么，但是如下图示意，在info字段中很清楚的显示出一个问题，那就是代理服务器会发送Connect请求到http代理服务器，导致代理完全清楚我们正在访问哪一个站点

2. 对 `eth0` 抓取的流量使用 `http.request.method eq GET 查看所有HTTP GET代理请求`，然后同时follow流，这里找到的是发向e.cuc.edu.cn的包

![](/img/0x03_13.png)

![](/img/0x03_12.png)

可以看到，http协议下，客户通过代理的服务器访问互联网，基本就是裸奔，**连cookie都明文发送**，极不安全



### 总结

从实验可以看出，代理服务器是极为不安全的一种上网方式，不论https还没有普及的时代，即使HTST协议普及的今天，传输的内容都被加密处理了，代理服务器仍然可以轻松了解我们正在访问的站点



## 参考链接

[课本](https://github.com/c4pr1c3/cuc-ns-ppt/blob/master/chap0x03.md)

[wireshark使用与主机代理插件](https://github.com/CUCCS/2021-ns-public-EddieXu1125/tree/chap0x03/chap0x03)
