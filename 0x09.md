# 实验九 入侵检测实验

## 实验目的

- 利用snort与suricata尝试进行入侵与检测

## 网络拓扑

方便起见，不按照[课本](https://c4pr1c3.gitee.io/cuc-ns/chap0x09/exp.html)上都配置成host-only网卡了，偷懒直接设置成NAT网络，拓扑图见下

<img src="/img/0x09_1.png" style="zoom:58%;" />

经过实践两者能联通

<img src="/img/0x09_2.png" style="zoom:60%;" />

## 实验环境

- kali 5.10.0-kali7-amd64（建议在root用户下进行实验）
- 在vm2上安装snort作为实验工具

```bash
# 禁止在apt安装时弹出交互式配置界面
sudo export DEBIAN_FRONTEND=noninteractive

apt install snort

# 查看snort配置文件
cat /etc/snort/snort.debian.conf
```

* 在vm1上安装nmap作为入侵方

```bash
apt install nmap
```

* **了解Snort基本指令参数**
  - -q  安静模式，不显示标志和状态报告。
  - -D  精灵模式，转为后台运行。
  - -v  从网络上读出数据包然后显示在控制台上。
  - -b  用二进制文件保存网络数据包，以应付高吞吐量的网络。
  - -i < if > 设置网络接口为< if >。可以用-W选项查询网络接口列表，然后用接口序号index指定接口。
  - -A < alert >   设置报警模式。
  - -c < cf >  使用配置文件< cf >，这会使得snort进入IDS模式，并从中读取运行的配置信息。
  - -l < ld >  设置数据包文件存放目录< ld >。默认目录是/var/log/snort。
  - ctrl c + ctrl z 终结当前模式

## 实验步骤

### 实验一：配置snort为嗅探模式

查看信息

![](/img/0x09_3.png)

```bash
# 开启测试模式测试snort配置
snort -T -c /etc/snort/snort.conf

# 显示IP/TCP/UDP/ICMP头
# -v         Be verbose
snort -v
```

![](/img/0x09_4.png)

```bash
# 显示应用层数据
# -d         Dump the Application Layer
snort -vd

# 显示数据链路层报文头
# -e         Display the second layer header info
snort -vde
```

![](/img/0x09_5.png)

```bash
# -b 参数表示报文存储格式为 tcpdump 格式文件
# -q 静默操作，不显示版本欢迎信息和初始化信息
snort -q -v -b -i eth1 "port not 22"

# 使用 CTRL-C 退出嗅探模式
# 嗅探到的数据包会保存在 /var/log/snort/snort.log.<epoch timestamp>
# 其中<epoch timestamp>为抓包开始时间的UNIX Epoch Time格式串
# 可以通过命令 date -d @<epoch timestamp> 转换时间为人类可读格式
# exampel: date -d @1511870195 转换时间为人类可读格式
# 上述命令用tshark等价实现如下：
# tshark -i eth1 -f "port not 22" -w 1_tshark.pcap
```

![](/img/0x09_6.png)

### 实验二：配置并启用snort内置规则

- 正确定义HOME_NET 和 EXTERNAL_NET，出于学习与实验目的将之设为any

  `vim /etc/snort/snort.conf`

- 启用snort内置规则

  `snort -q -A console -b -i eth0 -c /etc/snort/snort.conf -l /var/log/snort/`

> 注意：此处我开启了apache2服务，才能使用`nmap -sS -n -T4 10.0.2.9`命令做测试

![](/img/0x09_7.png)

![0x09_8](/img/0x09_8.png)

### 实验三：自定义snort规则

```bash
# 新建自定义 snort 规则文件

cat << EOF > /etc/snort/rules/cnss.rules
alert tcp \$EXTERNAL_NET any -> \$HTTP_SERVERS 80 (msg:"Access Violation has been detected on /etc/passwd ";flags: A+; content:"/etc/passwd"; nocase;sid:1000001; rev:1;)
alert tcp \$EXTERNAL_NET any -> \$HTTP_SERVERS 80 (msg:"Possible too many connections toward my http server"; threshold:type threshold, track by_src, count 100, seconds 2; classtype:attempted-dos; sid:1000002; rev:1;)
EOF
### 特别注意不要尝试用vim直接修改，否则其中的转义字符‘\’会被保留导致报错

# 添加配置代码到 /etc/snort/snort.conf
include $RULE_PATH/cnss.rules

# 重新启用规则
snort -q -A console -b -i eth0 -c /etc/snort/snort.conf -l /var/log/snort/
```

添加完成后，cd进入/var/log/snort目录，用`cat alert`命令查看警告信息

![](/img/0x09_9.png)

### 实验四：和防火墙联动

请先下载[本实验需要用到的脚本代码](https://c4pr1c3.gitee.io/cuc-ns/chap0x09/attach/guardian.tar.gz)，下载后解压缩

```bash
# 解压缩 Guardian-1.7.tar.gz
tar zxf guardian.tar.gz

# 安装 Guardian 的依赖 lib
apt install libperl4-corelibs-perl
```

进入guardian目录下，编辑 guardian.conf 并保存，确认以下2个参数的配置符合主机的实际环境参数。

```bash
HostIpAddr      10.0.2.9 # VM2
Interface       eth0
# 上述两个参数后面千万别跟空格，不然会遇到我接下来遇到的错误……改了一下午加一晚上才发现
```

**先开启Snort** `snort -D -q -A fast -b -i eth0 -c /etc/snort/snort.conf -l /var/log/snort/`

**再开启 guardian.pl** `perl guardian.pl -c guardian.conf`

在VM1上用` nmap 10.0.2.9 -A -T4 -n -vv`暴力扫描VM2；guardian.conf 中默认的来源IP被屏蔽时间是 60 秒（屏蔽期间如果黑名单上的来源IP再次触发snort报警消息，则屏蔽时间会继续累加60秒）

* snort的警告信息

![](/img/0x09_10.png)

* guardian提示的错误信息，显示程序没有得到正确的destination，导致无法修改iptables；在阅读guardian.pl以及结合报错信息后，我确定是在guardian.conf中修改HostIpAddr时莫名多加了一些空格，导致程序获取了dest之后无法和本机地址对上，致使错误发生，iptables不更新

![0x09_11](/img/0x09_11.png)

* 更改上述错误后，程序正常执行，iptables更新，并且在60秒之后自动刷新

![0x09_12](/img/0x09_12.png)

至此snort实验部分完结

## Suricata

### 实验一：配置 suricata 为嗅探模式

首先，`apt install suricata`下载suricata，然后用`vim /etc/suricata/suricata.yaml `修改suricata.yaml文件的HOME_NET和EXTERNAL_NET为any

![](/img/0x09_13.png)

```bash
# 日志文件在 /var/log/suricata/ 目录下
# fast.log 输出报警信息
# eve.json 数据详情
# stats.log 
# suricata.log
```

```bash
suricata -c /etc/suricata/suricata.yaml -i eth0    
# 使用suricata.yaml规则在eth0上开启监控服务

# 查看json格式的日志
cat /var/log/suricata/eve.json
```

尝试着ping一下百度后，日志刷新，说明测试正常。

![](/img/0x09_14.png)

#### 实验二：自定义suricata规则

```bash
#新建自定义suricata规则文件
vim /etc/suricata/rules/test.rules

#修改内容如下
alert tcp any any -> any any (msg:"hit baidu.com...";content:"baidu"; reference:url, www.baidu.com;)

# 将此文件加入到suricata.yaml中(大约在1870行左右)
```

![](/img/0x09_15.png)

接着，我们开启监听，用kali的浏览器访问百度，然后在eve.json中查看日志

![](/img/0x09_16.png)

发现有相应的告警信息，说明自定义规则匹配成功

### 实验三：和防火墙联动

先设置 iptables 的 NFQUEUE，，以让 Suricata 能访问到相应的数据包，可以使用如下命令

```bash
sudo iptables -I INPUT -p tcp -j NFQUEUE 
sudo iptables -I OUTPUT -p tcp -j NFQUEUE
```

![](/img/0x09_17.png)

然后使用如下命令让 Suricata 以 IPS 模式运行（其中，`-q` 说明以 IPS 模式运行）

```bash
sudo suricata -c /etc/suricata/suricata.yaml -q 0 
```

- 使用`iptables -vnL`查看是否在记录数据包

![](/img/0x09_18.png)

从上图的记录可知，Suricata正在运行，并且在记录数据包

### 思考题：IDS vs. IPS

入侵检测系统 IDS (Intrusion Detection Systems)：分析和监控网络流量，以查找表明攻击者正在使用已知网络威胁来渗透或窃取网络数据的标志。 IDS系统将当前网络活动与已知威胁数据库进行比较，以检测安全策略违规，恶意软件和端口扫描程序等多种行为。

入侵防御系统 IPS (Intrusion Prevention Systems) ：与防火墙位于网络的同一区域。 检查数据包的内容，主动阻止或阻止检测到的入侵。可以采取发送警报等措施，丢弃检测到的恶意数据包，重置连接或阻止来自违规IP地址的流量。还可以纠正循环冗余校验（CRC）错误，对数据包进行碎片整理，缓解TCP排序问题，并清理不需要的传输和网络层选项。

默认情况下，IDS/IPS 以混杂模式运行，这意味着设备捕获流量并将副本转发给 IDS/IPS 进行分析。因为处理的是流量副本，可以检测到攻击并发送警报（并采取其他操作），但不会阻止攻击进入网络或网段。而当 IPS 在内联(in-line)模式下工作时，它是直接工作在实际的流量路径中，可以检测威胁也可以进行防御。

相比而言， IDS 由于是被动检测，因此检测时可以进行更加复杂的分析；而 IPS 必须快速执行其检查和响应的工作，以避免降低网络性能并实时阻止潜在的攻击。

可以将某些 IDS 系统配置为采取预定义的主动操作以响应威胁。一个例子就是修改防火墙的规则以阻止来自特定IP地址的不需要的流量，这被称为响应型IDS。（就比如实验四中的 snort + guardian）

---

### 参考链接

[IDS vs. IPS: What is the Difference?](https://www.varonis.com/blog/ids-vs-ips/)

[师姐作业（特别注意：在kali上运行snort进行防火墙联动实验时不应用-D参数，会导致guardian停止工作）](https://github.com/CUCCS/2020-ns-public-chococolate/blob/chap0x09/chap0x09/chap0x09.md)

[第九章课本](https://c4pr1c3.gitee.io/cuc-ns/chap0x09/exp.html)

[suricata部分规则测试参考](https://github.com/CUCCS/2021-ns-public-luminous-123/tree/chap0x09/chap0x09#suricata)

